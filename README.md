# Бизнес-логика проекта Salesforce "m2"

## Описание

---

## Основные бизнес-процессы

### 1. Генерация счета (Invoice PDF)

- Для каждой сделки (Opportunity) можно автоматически сгенерировать счет в формате PDF.
- Счет формируется на основе Visualforce Page и включает:
  - Данные компании (из настроек организации)
  - Данные клиента (из основной контактной роли Opportunity)
  - Таблицу товаров (Opportunity Products) с итоговой суммой
  - Футер с названием компании
- Счет имеет формат A4, поддерживает многостраничность (шапка и футер повторяются).
- Счет сохраняется как PDF-файл и прикрепляется к Opportunity.
- Имя файла берется из поля "Invoice Number" (автонумерация, формат "INV-000000").
- Если файл с таким именем уже существует, создается новая версия через ContentVersion.

### 2. Подтверждение заказа по Email

- Входящий email обрабатывается сервисом OrderConfirmationEmailService.
- В теме или теле письма ищется номер счета (Invoice Number).
- Если найденная Opportunity находится в одном из допустимых статусов ("Pending Confirmation", "Prospecting", "Negotiation"):
  - Если в письме есть "Approved" или аналог — статус сделки меняется на "Closed Won".
  - Если "Rejected" или аналог — статус меняется на "Closed Lost".
- В ответе на email указывается результат обработки (успех/ошибка).

### 3. Статистика продаж (Sales Statistics)

- LWC-компонент отображает сводную статистику по клиентам и продажам.
- Может быть размещен как на отдельной вкладке, так и на странице Account.
- В режиме вкладки:
  - Аккордеон по аккаунтам: в заголовке имя и сумма закрытых сделок.
  - Внутри — таблица Opportunities (имя, дата создания, дата закрытия, сумма, кнопка "Товары").
  - Поиск по имени аккаунта и фильтр по сумме.
  - Пагинация по 10 аккаунтов на страницу.
- В режиме страницы Account:
  - Показываются только сделки текущего аккаунта.
  - Поиск, фильтр и пагинация скрыты.
- Кнопка "Товары" открывает модальное окно со списком Opportunity Products.

### 4. Email-рассылка счетов

- Быстрая кнопка "Send Invoice" открывает LWC-модалку для отправки счета клиенту.
- В модалке:
  - Предзаполнены тема письма, тело, имя и email получателя (из основной контактной роли).
  - Кнопка для предпросмотра PDF счета.
  - Кнопка "Send" отправляет письмо с вложением.

---

## Технические детали

- Все бизнес-процессы покрыты Apex unit-тестами.
- Используются стандартные компоненты Salesforce (LWC, Apex, Visualforce, ContentVersion).
- Вся логика фильтрации, поиска и пагинации реализована на сервере (Apex).
- Компоненты поддерживают локализацию (RU/EN).
- В проекте нет лишних комментариев — только чистый код.

---

## Краткая схема

1. Менеджер создает Opportunity → генерирует счет (PDF) → отправляет клиенту.
2. Клиент отвечает на email (Approved/Rejected) → статус сделки меняется автоматически.
3. Руководство анализирует продажи через компонент статистики.

---

## Контакты для поддержки

Если возникли вопросы по бизнес-логике или доработкам — обращайтесь к разработчику проекта.
